# OpenResty-based nginx.conf
worker_processes 1;

# select env vars (Lua access)
env S3_ENDPOINT;
env S3_BUCKET;
env S3_PREFIX;
env S3_ACCESS_KEY;
env S3_SECRET_KEY;
env S3_REGION;

error_log /dev/stderr;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # ----------------------------
    # Logging
    # ----------------------------
    log_format main escape=json '{'
        '"time_local":"$time_local",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"request_id":"$request_id",'
        '"request":"$request",'
        '"request_method":"$request_method",'
        '"request_uri":"$request_uri",'
        '"server_protocol":"$server_protocol",'
        '"status": $status,'
        '"body_bytes_sent":"$body_bytes_sent",'
        '"request_time":"$request_time",'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_connect_time":"$upstream_connect_time",'
        '"upstream_header_time":"$upstream_header_time",'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"upstream_addr":"$upstream_addr",'
        '"upstream_status":"$upstream_status",'
        '"http_x_forwarded_for":"$http_x_forwarded_for"'
    '}';

    access_log /var/log/nginx/access.log main;
    error_log  /var/log/nginx/error.log warn;

    # ----------------------------
    # Core HTTP settings
    # ----------------------------
    sendfile                 on;
    tcp_nopush               on;
    tcp_nodelay              on;
    keepalive_timeout        600s;

    types_hash_max_size      2048;
    include                  /usr/local/openresty/nginx/conf/mime.types;
    default_type             application/octet-stream;

    resolver                 127.0.0.11 ipv6=off valid=30s;
    resolver_timeout         1s;

    # ----------------------------
    # Compression
    # ----------------------------
    gzip                     on;
    gzip_proxied             off;
    gzip_disable             "msie6";
    gzip_vary                on;
    gzip_comp_level          6;
    gzip_min_length          256;
    gzip_types
        application/atom+xml
        application/geo+json
        application/javascript
        application/x-javascript
        application/json
        application/ld+json
        application/manifest+json
        application/rdf+xml
        application/rss+xml
        application/xhtml+xml
        application/xml
        font/eot
        font/otf
        font/ttf
        image/svg+xml
        text/css
        text/javascript
        text/plain
        text/xml;

    # ----------------------------
    # Timeouts / Limits
    # ----------------------------
    client_max_body_size     1000g;
    client_body_buffer_size  16k;

    proxy_read_timeout       600s;
    proxy_connect_timeout    60s;
    proxy_send_timeout       600s;
    send_timeout             600s;

    uwsgi_read_timeout       600s;
    uwsgi_connect_timeout    600s;
    uwsgi_send_timeout       600s;

    # ----------------------------
    # Sanitizers
    # ----------------------------
    map $http_user_agent $ua_sane {
        default $http_user_agent;
        "~[\r\n]" "bad_ua";
    }

    map $http_referer $ref_sane {
        default $http_referer;
        "~[\r\n]" "bad_referer";
    }

    map $http_x_forwarded_for $xff_sane {
        default $http_x_forwarded_for;
        "~[\r\n]" "bad_xff";
    }

    # ----------------------------
    # Bot detection (UA) + internal whitelist
    # ----------------------------
    map $http_user_agent $is_bot {
        default 0;
        "~*(CCBot|Googlebot-Images|Sogou|SenutoBot|SiteScoreBot|Twitterbot|YisouSpider|IABot|Turnitin|
        CFNetwork/.* Darwin|ClaudeBot|SemrushBot|Googlebot|Bingbot|Slurp|DuckDuckBot|Baiduspider|YandexBot|Sogou|Exabot|
        facebot|facebookexternalhit|Bytespider|AppleBot|Swiftbot|Slurp Bot|CCBot|GoogleOther|Google-InspectionTool|
        MJ12bot|Alexa crawler|Soso Spider|Pinterestbot|Dotbot|AhrefsBot|archive.org_bot|scrapy|PetalBot|
        SemrushBot|Amazonbot|DataForSeoBot|crawl-66-249-66-200.googlebot.com|rdap.arin.net|meta-externalagent)" 1;
    }

    # 0 = internal/trusted (do not block bots), 1 = external (apply bot rules)
    geo $limit_bot {
        default 1;
        10.0.0.0/8     0;
        172.16.0.0/12  0;
        192.168.0.0/16 0;
    }

    map "$is_bot:$limit_bot" $block_bot {
        "1:1" 1;
        default 0;
    }

    # ----------------------------
    # Explicit blocked IPs (SCRUBBED)
    # ----------------------------
    geo $is_blocked_ip {
        default 0;
        # Add blocked CIDRs/IPs privately (do not commit publicly).
        # 203.0.113.0/24 1;
        # 198.51.100.10  1;
    }

    # ----------------------------
    # Rate limiting + CORS origin mapping (SCRUBBED)
    # ----------------------------
    geo $limited {
        default 1;
        # Keep RFC1918 private ranges exempt (optional)
        10.0.0.0/8       0;
        172.16.0.0/12    0;
        192.168.0.0/16   0;

        # Add trusted public subnets/IPs privately
    }

    map $http_referer $cors_header {
        default "";
        # Add allowed referrers privately
        # "https://example.org/" "https://example.org/";
    }

    map "$cors_header:$limited" $final_limit {
        ":1" $binary_remote_addr;
        ":0" "";
        default "";
    }

    limit_req_zone $final_limit zone=image_zone:10m rate=6r/m;

    # If Ultimate Bad Bot Blocker is installed
    include /etc/nginx/conf.d/globalblacklist.conf;
    include /etc/nginx/conf.d/botblocker-nginx-settings.conf;

    server {
        listen 80 default_server;
        server_name _;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        server_name _;

        ssl_certificate     /etc/ssl/certs/wildcard_calacademy_org.pem;
        ssl_certificate_key /etc/ssl/private/wildcard_calacademy_org.key;

        # uwsgi buffer settings
        uwsgi_buffer_size         128k;
        uwsgi_buffers             4 256k;
        uwsgi_busy_buffers_size   256k;

        include /etc/nginx/bots.d/blockbots.conf;
        include /etc/nginx/bots.d/ddos.conf;

        # Block bots (except internal IPs)
        if ($block_bot) {
            return 403;
        }

        # Block known bad IPs
        if ($is_blocked_ip) {
            return 403;
        }

        location = /robots.txt {
            default_type text/plain;
            add_header Cache-Control "max-age=3600, public";
            alias /srv/app/views/robots.txt;
        }

        # ------------------------------------------------------------
        # Internal S3 acceleration location
        # Bottle returns: X-Accel-Redirect: /_s3_internal/<bucket>/<key>?dn=...
        # Nginx signs request to MinIO (SigV4 via Lua) and streams bytes directly.
        # ------------------------------------------------------------
        location ~ ^/_s3_internal/(?<bucket>[^/]+)/(?<key>.*)$ {
            internal;

            # Expose captured vars to Lua signer
            set $s3_bucket $bucket;
            set $s3_key    $key;

            # MinIO endpoint (add match your S3_ENDPOINT host/port here)
            set $s3_scheme https;
            set $s3_host   placeholder-gateway.org;
            set $s3_port   11111;

            # Signing region
            set $s3_region us-east-1;

            # Content-Disposition defaults; Bottle passes dn=... sometimes.
            set $disp inline;
            if ($arg_disp != "") { set $disp $arg_disp; }
            if ($arg_dn != "") {
                add_header Content-Disposition "$disp; filename=\"$arg_dn\"";
            }

            # Proxy settings for large files
            proxy_request_buffering off;
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_ssl_server_name on;
            proxy_ssl_verify off;

            # SigV4 signing for MinIO
            access_by_lua_file /usr/local/openresty/nginx/lua/s3_sign.lua;

            # Do not forward dn/disp query args to MinIO
            proxy_pass $s3_scheme://$s3_host:$s3_port/$bucket/$key;
        }

        location / {
            # CORS headers (decided by $cors_header)
            add_header 'Access-Control-Allow-Origin'  $cors_header always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept' always;

            if ($request_method = OPTIONS) {
                return 204;
            }

            limit_req zone=image_zone burst=2 nodelay;

            try_files $uri @image-server;
        }

        location @image-server {
            uwsgi_pass image-server:29000;
            include /usr/local/openresty/nginx/conf/uwsgi_params;

            uwsgi_param Host               $host;
            uwsgi_param X-Real-IP          $remote_addr;
            uwsgi_param X-Forwarded-For    $proxy_add_x_forwarded_for;
            uwsgi_param X-Forwarded-Proto  $http_x_forwarded_proto;
            uwsgi_param X-Request-Id       $request_id;

            # Allow Bottle to trigger internal redirects to /_s3_internal/...
            uwsgi_pass_header X-Accel-Redirect;
            uwsgi_pass_header Content-Disposition;
            uwsgi_pass_header Content-Type;
        }
    }
}
